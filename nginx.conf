# /etc/nginx/sites-available/radarfutebol.xyz
#
# Segurança multi-camada:
# 1. UFW: IPs maliciosos bloqueados (ufw insert 1 deny)
# 2. Bot UA: HeadlessChrome, curl, python, etc bloqueados ($is_scraper_bot)
# 3. IP restrict: APIs (/betfair-api, /matchbook-api, /wh-api) só QNAX
# 4. Referer: Scoreboard/CDN exige Referer de radarfutebol.com/xyz
# 5. Origin: WebSocket verifica origin na query string
# 6. CSP: frame-ancestors só permite radarfutebol.com
#
# Requer: /etc/nginx/conf.d/radarfutebol-security.conf (maps de bot e skip)

server {
    server_name radarfutebol.xyz;

    # IPs bloqueados manualmente
    deny 18.171.141.153;

    # CSP - apenas radarfutebol.com pode embutir iframe
    add_header Content-Security-Policy "frame-ancestors 'self' https://radarfutebol.com https://www.radarfutebol.com" always;

    # Bloquear bots/scrapers (exceto servidor QNAX)
    set $block_bot 0;
    if ($is_scraper_bot = 1) {
        set $block_bot 1;
    }
    if ($remote_addr = 185.194.204.133) {
        set $block_bot 0;
    }
    if ($skip_bot_check = 1) {
        set $block_bot 0;
    }
    if ($block_bot = 1) {
        return 403;
    }

    # Betfair API - apenas servidor QNAX
    location /betfair-api/ {
        allow 185.194.204.133;
        deny all;

        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
    }

    # Matchbook API - apenas servidor QNAX
    location /matchbook-api/ {
        allow 185.194.204.133;
        deny all;

        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
    }

    # William Hill API - apenas servidor QNAX
    location /wh-api/ {
        allow 185.194.204.133;
        deny all;

        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
    }

    # Health e Stats - aberto para monitoramento
    location = /health {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }

    location = /stats {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }

    # WebSocket (diffusion) - verificar origin na query string
    location /diffusion {
        # Bloquear origens nao autorizadas na query string
        # A query contem sp={"origin":"https://..."}
        # Se tem origin na query: bloquear por padrao
        set $ws_allowed 1;
        if ($args ~* "origin%22%3A%22") {
            set $ws_allowed 0;
        }
        # Permitir origin de radarfutebol
        if ($args ~* "origin%22%3A%22https%3A%2F%2Fradarfutebol") {
            set $ws_allowed 1;
        }
        # Permitir origin de whcdn (William Hill CDN)
        if ($args ~* "origin%22%3A%22https%3A%2F%2Fsports\.whcdn") {
            set $ws_allowed 1;
        }
        # Sempre permitir QNAX
        if ($remote_addr = 185.194.204.133) {
            set $ws_allowed 1;
        }
        if ($ws_allowed = 0) {
            return 403;
        }

        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
    }

    # Scoreboard e CDN - EXIGIR Referer de radarfutebol.com ou radarfutebol.xyz
    location / {
        valid_referers server_names
            radarfutebol.com www.radarfutebol.com *.radarfutebol.com
            *.radarfutebol.xyz;

        set $ref_block $invalid_referer;
        if ($remote_addr = 185.194.204.133) {
            set $ref_block 0;
        }
        if ($ref_block) {
            return 403;
        }

        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
    }

    listen 443 ssl;
    ssl_certificate /etc/letsencrypt/live/radarfutebol.xyz/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/radarfutebol.xyz/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
}

server {
    if ($host = radarfutebol.xyz) {
        return 301 https://$host$request_uri;
    }
    listen 80;
    server_name radarfutebol.xyz;
    return 404;
}
